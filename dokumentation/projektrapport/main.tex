\documentclass[a4paper]{article}

\usepackage[swedish]{babel}
\usepackage[T1]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage{graphicx}
\usepackage{float}

\newcommand\namn{Larmsystem}

\restylefloat{table}

\begin{document}


\thispagestyle{empty}

\begin{center}
    \parskip=14pt
    \vspace*{3\parskip}

    {\LARGE Projektrapport DAT290}

    {\large \namn, grupp 11

    Titus Blosse, Viktor Frideen, Nazif Kadiroglu, Markus Moen, Lukas Schiavone, Fredrik Österström

    \today}

    \rule{7cm}{0.4pt}\\
\end{center}
\newpage

\thispagestyle{empty}

\tableofcontents
\newpage

\pagenumbering{arabic}

\section*{Ordlista}

\begin{description}
    \item[CAN:] Controller Area Network
    \item[IDE:] Integrated Development Environment
    \item[MD407:] Mikrodator av typen MD407
\end{description}
\newpage

\section{Inledning}
\subsection{Syfte}
Inbrott är ett vanligt problem i Sverige. År 2019 anmäldes 75.250 inbrottstölder. En minskning med 14\% från året innan \cite{brastold}. Vanliga sätt att förhindra inbrott är grannsamverkan, certifierade lås mot inbrott och hemlarm. Larmsystem minskar risken för ett inbrott och möjliggör ytterligare minskning både i Sverige och i resten av världen.

\subsection{Mål}

Produkten ska erbjuda ett flertal larmkomponenter som kan anslutas till en larmcentral och konfigureras för att passa kundens specifika situation. Dessutom skall systemet ska vara dokumenterat och fackmannamässigt utfört med förutsättningar för expansion.

Grunden i systemet kommer vara en centralenhet till vilken användaren kan ansluta periferienheter. Huvudsakligen kommer två periferienheter att utvecklas, ett dörrlarm och ett rörelselarm.

Dörrlarmet triggar ett larm då en dörr står öppen längre än ett givet tidsinterval. Inledningsvis sätts larmet igång lokalt på perifirienheten. Om larmet inte hanteras inom ett givet tidsintervall vidarebefordras larmet till centralenheten. Då kommer användaren, med hjälp av ljud och display, få ett meddelande om att larmet har utlöst. När larmet väl har startat ska det krävas en manuell inmatning av fyrsiffrig kod på knapsatsen för att larma av.

I mån av tid kommer extra funktionalitet implementeras. Denna extra funktionalitet är ett testläge för pereferienheterna, ett lokalt larm för rörelsesensorn, och ett inbyggt skydd mot ''replay attacker''.

\subsection{Bakgrund}
Meningen med larmsystem är att varna om inbrott i till exempel en bil, fastighet eller ett område. Dessutom har larmsystemet som i uppgift att avskräcka potentiella brottslingar.

Beståndsdelarna i larmsystemet är en centralenhet och periferienheter. Komponenterna skapar tillsammans möjligheten att till exempel, larma på/av, koppla samman enheter eller inställning av befintliga enheter. Koppling sker via instruktioner som kan skickas både manuellt eller automatiskt via en av komponenterna.

\subsection{Arbetsmetod}

All mjukvara för projektet har skrivits i programspråket C. C är ett lågt programmeringsspråk vilket krävs för utveckling av mjukvara till mikrodatorn MD407, vilket är hårdvaran som utgör grunden för detta projekt. Utvecklingen av mjukvaran har skett i IDE:n (Integrated Development Environment) CodeLite. CodeLite användes då gruppmeddlemmarna sedan tidagare har erfarenhet med IDE:n samt att den lämpar sig bra för utveckling mot MD407.

Versionshantering har gjorts med hjälp av git. Ett gemensamt repository skapades på GitHub där all kod för projektet samlades.

Majoriteten av testningen utfördes direkt på hårdvaran i Chalmers lokaler. Viss testning har genomförts med hjälp av mjukvaran Simserver som tillåter att simulera MD407 kortet. Funktionaliteten hos Simserver är dock begränsad därför har den största delen av testningen behövts utföras i Chalmers laborationssalar.

Arbetsgruppen delades inledningsvis upp i tre undergrupper som ansvarade över olika delar av utvecklingen. Därefter utvecklade undergrupperna mjukvaran som var grunden för deras specifika område för att sedan i små steg utöka funktionaliteten. Under utvecklingens gång suddades gränserna mellan grupperna ut då dem separata mjukvarorna integrerades och gemensamt arbete blev fördelaktigt.


\section{Teknisk Beskrivning}
I detta avsnitt ges en fördjupad inblick i hur systemet som utvecklats under projektet fungerar och hänger ihop. Den mjukvara och hårdvara som projektet baseras på beskrivs även i mer detalj.

\subsection{Teknisk Bakgrund}
Hårdvaran vilket system körs på är en MD407 mikrodator. All mjukvara är skriven i programspårket C. MD407 har begränsat med minne vilket gör att programmen som skrivs för mikrodatorn bör vara små och effektiva. C är ett lågt programspråk vilket medför att programmeraren har stor kontroll över minneshanteringen i programmet. C lämpar sig alltså väl för utveckling mot MD407.

Systemet kretsar kring att flera MD407 sammankopplas, en MD407 agerar då som centralenhet och resterande används för att ansluta periferienheter så som dörrlarm och rörelsesensorer. MD407-korten kommunicerar via ett protokoll som baserats på CAN (Controllerar Area Network),vilket är ett färdigutvecklat protokoll för kommunikation mellan datorer. Ett kommunikationsprotokoll har sedan byggts ovanpå CAN som är anpassat för systemet.

\subsection{Systemöversikt}

Vid uppstart väljs en MD407 som centralenhet för systemet. Från denna enhet körs huvudprogrammet. Centralenheten sköter den stora delen av systemets funktion. Centralenheten registrerar och håller koll på vilka periferienheter som är ansluta, kontrollerar kontinuerligt så att inget larm gått hos periferienheterna samt tar input från ansluten dator för att styra systemet.

Två olika periferienheter finns tillgängliga att ansluta till systemet. Ett dörrlarm, vilket kontrollerar ifall en dörr är öppen eller stängd, samt en rörelsesensor som mäter avståndet till föremålet framför den och registrerar ifall detta förändras. Om dörren är öppen längre än en förutbestämd tid eller om rörelsesensorn registrerar en stor avvikelse i avstånd kommer perifirienheterna larma. Om larmet fortsätter tillräcklig länge kommer perifirienheten i fråga skicka ett meddelande till centralenheten.

\begin{table}
  \centering
  \begin{tabular}{|c|c|}
    \hline
    Prioritet & Meddelande-ID \\
    \hline
    0 & ALARM \\
    \hline
	  1 & ERROR \\
    \hline
	  2 & ALARM\_OFF \\
    \hline
	  3 & POLL\_REQUEST \\
    \hline
	  4 & POLL\_RESPONSE \\
    \hline
    5 & DICP\_REQUEST \\
    \hline
    6 & DICP\_RESPONSE \\
    \hline
    7 & TOL\_SET \\
    \hline
    8 & ACTIVE\_ON \\
    \hline
    9 & ACTIVE\_OFF \\
    \hline
  \end{tabular}
  \caption{Samtliga meddelandetyper och deras prioritet.}
  \label{tab:meddelandetyper}
\end{table}


\subsubsection{CAN}
För hantering av kommunikationonen mellan enheterna har ett kommunikationsprotokoll utvecklats. Basen till kommunikationsprotokollet är så kallade CAN-meddelanden som skickas mellan enheterna.

CAN är ett protokoll för kommunikation och hantering av meddelanden mellan enheter. CAN-protokollet måste därför finnas hos både periferienhet och centralenhet. Koden är därför strukturerad utifrån att samma kod kan köras på valfri enhet oavsett typ. Med hjälp av riktning och ID kan alla enheter ta emot och skicka meddelanden till godtycklig mottagare. Varje CAN-meddelande byggs upp av fem fält:

\begin{description}
    \item[Riktning:] Detta fält anger om meddelandet går till eller från centralenheten.
    Fältet sätts till TO\_PERIPHERAL, motsvarande noll om meddelandet går från centralenhet till periferienhet och TO\_CENTRAL, motsvarande ett om meddelandet går från periferienhet till centralenhet.
    Detta fält tillåter en minskning av antalet meddelandetyper då en generell meddelandetyp så som ALARM kan användas åt båda hållen.

    \item[Meddelande-ID:] Meddelanden delas upp i meddelandetyper, till exempel: ALARM och ERROR. Alla meddelandetyper finns samlade i en enum vilket gör att meddelandetyperna har en intern prioritet. Ju närmare noll, desto högre prioritet. Samtliga meddelandetyper finns samlade i tabell \ref{tab:meddelandetyper}.

    \item[Enhets-ID:] Varje ansluten enhet tilldelas ett unikt enhets-ID, mellan 0x0-0x14. 0x15 är reserverat för ID-tilldelning. Ett lägre enhets-ID innebär högre prioritet.
    Centralenheten tilldelar enheterna ett ID i ordningen de anslöt sig i.

    \item[Längd:] Längd är en indikation på hur mycket data som skickas med i meddelandets datafält.
    Många meddelanden skickas med längd noll då mycket information om meddelandet kan utläsas från meddelande-ID och enhets-ID.

    \item[Data:] I detta fält lagras den data som skickas med i meddelandet. Ett meddelande kan lagra upp till 64 bitar av data.
\end{description}

\begin{table}[H]
    \centering
    \resizebox{\textwidth}{!}{\begin{tabular}{|c|c|c|c|c|c|c|c|c|c|c|c|c|c|c|}\hline
        \multicolumn{1}{|c|}{Riktning} & \multicolumn{6}{|c|}{Meddelande-ID} & \multicolumn{4}{|c|}{Enhets-ID} & \multicolumn{3}{|c|}{Längd} & \multicolumn{1}{|c|}{Data (8 bytes)} \\\hline
        0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 0 & 1 & 0 & 0 & 0 & 0 \\\hline
        \multicolumn{1}{|c|}{TO\_CENTRAL} & \multicolumn{6}{|c|}{ALARM} & \multicolumn{4}{|c|}{Node.id} & \multicolumn{3}{|c|}{0} & \multicolumn{1}{|c|}{0} \\\hline
    \end{tabular}}
    \caption{Diagram över CAN-meddelandets uppbyggnad samt ett exemepl på hur ett alarm-meddelande från en periferienhet ser ut.}

\end{table}

\subsubsection{Centralenhet}
Centralenheten avlyssnar efter meddelanden kontinuerligt.
Ett meddelande kan till exempel innefatta ett alarm, ny enhet eller att det uppstått ett fel.
Den anvarar även för förfrågningar till periferienheterna för att undersöka att inget kopplats bort.
Vid alarm så registrerar centralenheten det och avaktiverar endast alarmet om rätt kod är inmatad på tangentbordet.

%skickas för att säkerställa att enheten i fråga fortfarande är ansluten och inte larmar. I pollingmeddelandet

\subsubsection{Periferienhet}
Periferienheterna avlyssnar sina sensorer och rapporterar ett alarm till centralenheten om tröskeln för sensortypen är överskriden.
För att inte centralenheten ska initiera ett alarm måste periferienheterna kunna svara på dess förfrågan.
När periferienheten initialiseras hämtas en identifierare från centralenheten via CAN. Det finns två typer av periferienheter:

\begin{description}
  \item[Dörrsensor:] Dörrsensorns uppgift är att upptäcka om en dörr är öppen eller stängd. Värdet på sensorn läses av från PE0 som är konfigurerad med en Pull-Up-resistor.
  Vid öppnad dörr bryts kretsen och det logiska värdet blir en etta. Vid sluten krets är det logiska värdet på kretsen en nolla.

  \item[Rörelsesensor:] Rörelsesensorns uppgift är att upptäcka skillnader i avstånd.
  För att kunna läsa ett värde från sensorn måste en logisk etta skrivas till trig-pinnen i minst 10 \textmu s.
  Sensorn svarar med att skriva en logisk etta på echo-pinnen.
  Längden av denna logiska etta motsvarar det uppmätta avståndet.
\end{description}

\section{Resultat}
Denna sektion inleds med en presentation av reslutatet av systemet i sin helhet föjt av djupare granskning av dom olika delsystemen. Resultat från utförda tester visas även upp i denna sektion.

\subsection{Larmsystem}
Systemet utför sin grundligaste uppgift, en sensor skickar vid upptäckt intrång signal till centralenheten som i sin tur larmar och på så vis uppmärksammar användaren om intrång. Möjlighet för användaren att ställa känslighet hos sensorerna samt på vilka grunder periferienheterna ska larma är implementerat.

Systemet stödjer i teorin att upp till 16 periferienheter ansluts, detta har ej testats då den mängden hårdvara inte finns tillgänglig. (?)Systemet vidhåller sin funktionalitet även när en störningsenhet är ansluten, detta tyder på att systemet kan hantera 16 anslutna enheter(?).

\subsubsection{Centralenhet}
Centralenheten fungerar som förväntat. Vid utsöndring av larm skickas ett meddelande till en ansluten terminal via centralenheten. I terminalen skrivs detaljer om larmet ut. Larmet bryts via terminalen eller knappsatsen som är kopplad till centralenheten. Utöver detta larmar även centralenheten vid tappad kontakt av perifirienheterna.

Centralenheten lagrar det antal enheter som är anslutna till systemet och skickar kontinuerligt pollingmeddelanden till enheterna. Dessa pollingmeddelanden innehåller ett meddelande som periferienheten förväntas svara på, detta fyller sin funktion i att skydda från ´replay attacker´.

\subsubsection{Dörrsensor}
Enheten för dörrlarmet motsvarar förväntningar. Enheten kan hålla upp till 16 olika dörrar under bevakning. Konstuktionen av enheten möjliggör för både ett lokalt larm och även ett larm som skickas till centralenheten. Primärt kommer perifirienheterna larma lokalt. Om dörrlarmet stått längre än ett förutbestämd tidsintervall kommer även centralenheten larmas. I centralenheten kan tidsintervaller konfigureras.

\subsubsection{Rörelsesensor}
Rörelsesensorn funkar och uppfyller kraven. Genom använding av avståndsmätare bekräftar enheten om någon passerat en given yta. Rörelsesensorn observerar 5 seanste tiderna och tar medelvärdet av dessa för. Därefter jämförs medelvärdet med nästkommande medelvärde. Detta utför sensorn automatiskt och konstant. Om ett medelvärde skiljer sig en förutbestämd tid med ett marginal som sätts vid kundens begäran, kommer ett larm att utsöndras.

\subsubsection{kommunikationsprotokoll}
lorem ipsum

\subsubsection{Exta funktionalitet}
Ska vi ha med detta avsnitt?

\subsection{Tester}
Tester? Tester!

%Systemet fungerar som önskat där enhetens alla delar kommunicerar och sammarbetar vilket resulterar i ett effektivt larmsystem.

\section{Slutsatser}
Larmsystemet består av en centralenhet och olika perferienheter. Centralenheten hanterar meddelanden från perferienheterna för att larma på/av. Perferienheterna avlyssnar sina sensorer för att rapportera till centralenhet för alarm. För att larma av finns en knappsats för att slå in en förbestämd kod. 



Det slutgiltiga systemet är ett bevis på att det är möjligt att konstruera ett enkelt larmsystem med grundliga kunskaper inom maskinorienteradprogramering och MD407-kort. Det visade sig däremot vara svårare än tänkt och deadlines för hårdvaran missades med några dagar. 

Det finns en del utvecklingsmöjligheter för systemet. Men jag kommer inte på dem just nu. 

\bibliographystyle{IEEEtran}

\bibliography{referenser.bib}

\end{document}
